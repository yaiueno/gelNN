# 使い方ガイド

このガイドでは、各バッチファイルの使用方法を説明します。

## 📋 目次

1. [HILSフルシステム起動](#1-hilsフルシステム起動)
2. [データ収集・学習・推論](#2-データ収集学習推論)
3. [周波数分析（HILS）](#3-周波数分析hils)
4. [周波数分析（実機）](#4-周波数分析実機)
5. [モデル学習（バッチ）](#5-モデル学習バッチ)
6. [自動テスト](#6-自動テスト)
7. [分類器単独起動](#7-分類器単独起動)

---

## 1. HILSフルシステム起動

**ファイル:** `01_start_hils_full_system.bat`

### 目的
HILSシステム全体（サーバー、コントローラー、分類器）を一括起動します。

### 起動される画面
1. **HILS Server** - バックエンドサーバー（WebSocket）
2. **HILS Controller** - タッチ位置操作GUI
3. **Classifier App** - リアルタイム分類結果表示

### 使い方
1. バッチファイルをダブルクリック
2. 3つのウィンドウが順次起動します
3. HILS Controllerでイオンゲル画面をクリック
4. Classifier Appで予測結果を確認

### 注意事項
- `src\utils\config.py` で以下の設定が必要です：
  ```python
  USE_REAL_HARDWARE = False
  USE_HILS_SERVER = True
  ```

### トラブルシューティング
- **サーバーが起動しない**: ポート8765が使用中でないか確認
- **GUIが表示されない**: tkinter/customtkinterがインストールされているか確認

---

## 2. データ収集・学習・推論

**ファイル:** `02_data_collection_and_training.bat`

### 目的
インピーダンスデータの収集、モデル学習、推論テストを行います。

### 機能
- **データ収集**: キャンバス上の任意の位置でデータ収集（HILSモード）
- **グリッド収集**: 3×3グリッドで系統的にデータ収集（実機モード）
- **モデル学習**: MLPRegressorで位置推定モデルを学習
- **推論**: リアルタイムでタッチ位置を推定

### 使い方

#### HILSモード
1. バッチファイルをダブルクリック
2. "Start Collection" をクリック
3. キャンバス上の任意の位置をクリック（各位置で10サンプル推奨）
4. 複数の位置でデータ収集（最低20位置以上推奨）
5. "Stop Collection" をクリック
6. "Train Model" をクリックして学習開始
7. 学習完了後、"Start Inference" でリアルタイム推論を開始

#### 実機モード
1. AD3とArduinoを接続
2. `src\utils\config.py` で `USE_REAL_HARDWARE = True` に設定
3. バッチファイルをダブルクリック
4. P0～P8ボタンを順にクリック
5. 各位置でイオンゲルに指を置き、"Measure" をクリック
6. 全位置でデータ収集後、"Train Model" をクリック
7. "Start Inference" で推論テスト

### データ保存先
- 学習データ: `data/training_data_YYYYMMDD_HHMMSS.pkl`
- モデル: `models/model.pkl`
- スケーラー: `models/scaler.pkl`

### Tips
- データは多いほど精度が向上します（100サンプル以上推奨）
- グリッド全体に均等にデータを配置してください
- 実機モードでは各測定間に1秒程度の間隔を空けてください

---

## 3. 周波数分析（HILS）

**ファイル:** `03_frequency_analysis_hils.bat`

### 目的
HILSシミュレータを使用して、周波数特性を分析し、最適な測定周波数を決定します。

### 実行内容
1. 複数の周波数（デフォルト：100Hz～100kHz、20点）でインピーダンスデータを収集
2. 各周波数でのクラス分離性能を評価
   - Fisher比（クラス間分散/クラス内分散）
   - Silhouette score（クラスタリング品質）
3. 最適周波数を決定し、設定ファイルに保存

### 使い方
1. バッチファイルをダブルクリック
2. 分析開始（5～10分程度）
3. 進行状況がコンソールに表示されます
4. 完了後、結果が `frequency_config.json` に保存されます
5. グラフが表示されます（表示されない場合は手動で開く）

### 出力ファイル
- `frequency_config.json` - 最適周波数と詳細な分析結果
- `frequency_analysis_results.png` - 可視化グラフ（Fisher比、Silhouette score）

### カスタマイズ
コマンドラインで直接実行する場合：
```cmd
python -m src.utils.frequency_analyzer --mode hils --min-freq 500 --max-freq 50000 --num-points 20
```

パラメータ：
- `--min-freq`: 最小周波数（Hz）
- `--max-freq`: 最大周波数（Hz）
- `--num-points`: サンプル点数

---

## 4. 周波数分析（実機）

**ファイル:** `04_frequency_analysis_real.bat`

### 目的
実機（AD3 + Arduino）を使用して、実際のイオンゲルの周波数特性を分析します。

### 前提条件
- AD3が接続されている
- Arduinoが接続されている
- `src\utils\config.py` で `USE_REAL_HARDWARE = True` に設定

### 使い方
1. すべてのハードウェアを接続
2. 接続を確認（AD3のLEDが点灯）
3. バッチファイルをダブルクリック
4. 分析開始（10～30分程度）
5. 各周波数で測定が実行されます
6. 完了後、結果が保存されます

### 注意事項
- 実機モードでは測定に時間がかかります
- 測定中は機器を動かさないでください
- 温度変化を避けるため、安定した環境で測定してください
- 各周波数での測定エラーは自動的にスキップされます

### データ品質の確保
- 測定前にウォームアップ（5分程度AD3を起動しておく）
- イオンゲルの状態を確認（乾燥していないか）
- ノイズの少ない環境で測定

---

## 5. モデル学習（バッチ）

**ファイル:** `05_train_classifier_model.bat`

### 目的
9点グリッド分類器を学習します（GUI不要のバッチ処理）。

### 実行内容
1. 3×3グリッド（9点）の位置を自動生成
2. 各点で30サンプル（デフォルト）のインピーダンスデータを収集
3. MLPClassifierで学習
4. モデルとスケーラーを保存

### 使い方
1. バッチファイルをダブルクリック
2. 自動的にデータ収集・学習が実行されます
3. 進行状況がコンソールに表示されます
4. 完了後、モデルが `models/` ディレクトリに保存されます

### 出力ファイル
- `models/classifier_model.pkl` - 学習済み分類器
- `models/classifier_scaler.pkl` - 特徴量スケーラー
- `models/grid_positions.json` - グリッド位置情報

### パラメータカスタマイズ
コマンドラインで実行する場合：
```cmd
python scripts\train.py --samples 50 --grid-size 3
```

パラメータ：
- `--samples`: 1位置あたりのサンプル数（デフォルト：30）
- `--grid-size`: グリッドサイズ（デフォルト：3×3）

### Tips
- サンプル数を増やすと精度が向上しますが、時間もかかります
- HILSモードでの学習は数分で完了します
- 実機モードでは15～30分程度かかります

---

## 6. 自動テスト

**ファイル:** `06_run_automated_test.bat`

### 目的
システム全体の動作を自動的にテストし、性能を評価します。

### 実行内容
1. ランダムな位置（デフォルト：20位置）でデータ収集
2. 各位置で複数サンプル収集
3. MLPRegressorで学習
4. テスト位置（デフォルト：10位置）で推論を実行
5. 誤差メトリクスを計算・出力

### 使い方
1. バッチファイルをダブルクリック
2. テストが自動実行されます
3. 進行状況がコンソールとログファイルに出力されます
4. 完了後、統計情報が表示されます

### 出力
- **コンソール出力**:
  - 平均誤差（Mean Error）
  - 標準偏差（Std Dev）
  - 最大誤差（Max Error）
  - 各テストポイントの詳細
  
- **ログファイル**: `logs/test_log_YYYYMMDD_HHMMSS.txt`
  - 全測定データ
  - 詳細な統計情報
  - エラー分析

### 評価指標
- **平均誤差**: 5mm以下が目標
- **標準偏差**: 3mm以下が目標
- **最大誤差**: 10mm以下が目標

### Tips
- テスト前に周波数分析を実行すると精度が向上します
- ログファイルを比較して性能の変化を追跡できます

---

## 7. 分類器単独起動

**ファイル:** `07_classifier_app_only.bat`

### 目的
分類器GUIのみを起動します（サーバーは別途起動済みの前提）。

### 前提条件
- HILS Serverが起動している
- 学習済みモデルが存在する（`models/classifier_model.pkl`）

### 使い方
1. 別のターミナルで HILS Server を起動:
   ```cmd
   python run_hils_server.py
   ```
2. バッチファイルをダブルクリック
3. 分類器GUIが起動し、サーバーに接続
4. 9点グリッドに確率が表示されます

### 表示内容
- **グリッドセル**: 各位置の予測確率（色で表現）
- **予測位置**: 最も確率が高い位置
- **確率値**: パーセント表示
- **メトリクス**: 平均確率、エントロピー

### 使用シーン
- サーバーとGUIを別々に起動したい場合
- 複数のクライアントで同じサーバーに接続する場合
- デバッグ時にサーバーとクライアントを分離したい場合

---

## 📊 推奨ワークフロー

### 初めて使う場合

#### ステップ1: システム動作確認（5分）
```
01_start_hils_full_system.bat
```
- HILSフルシステムを起動
- HILS Controllerでクリック操作
- Classifier Appで結果を確認
- システム全体の動作を理解

#### ステップ2: 周波数特性の理解（10分）
```
03_frequency_analysis_hils.bat
```
- 周波数特性を分析
- 最適周波数を確認
- グラフで特性を理解

#### ステップ3: データ収集・学習（15分）
```
02_data_collection_and_training.bat
```
- HILSモードでデータ収集
- 複数位置でサンプル収集（20位置以上推奨）
- モデル学習
- 推論テスト

#### ステップ4: 性能評価（10分）
```
06_run_automated_test.bat
```
- 自動テストで精度確認
- ログファイルで詳細分析

### 実機で使う場合

#### ステップ1: 設定変更
`src\utils\config.py` を編集:
```python
USE_REAL_HARDWARE = True
USE_HILS_SERVER = False
```

#### ステップ2: ハードウェア接続確認
- AD3を接続（USBケーブル）
- Arduinoを接続（USBケーブル）
- Arduinoに mux_controller.ino を書き込み済みか確認
- イオンゲルを4端子に接続

#### ステップ3: 周波数分析（30分）
```
04_frequency_analysis_real.bat
```
- 実機での周波数特性を測定
- 最適周波数を決定
- `frequency_config.json` に保存

#### ステップ4: データ収集・学習（30分）
```
02_data_collection_and_training.bat
```
- P0～P8の各位置でデータ収集
- 各位置で指を置いてMeasure
- モデル学習
- 推論テスト

#### ステップ5: 性能評価
```
06_run_automated_test.bat
```
- 実機での精度確認
- 必要に応じてデータ追加収集

---

## ❓ トラブルシューティング

### バッチファイルが起動しない

**症状**: ダブルクリックしても何も起こらない

**原因と対策**:
1. Pythonがインストールされていない
   ```cmd
   python --version
   ```
   → Python 3.8以降をインストール

2. パスが通っていない
   → 環境変数PATHにPythonのパスを追加

3. 依存パッケージが不足
   ```cmd
   pip install -r requirements.txt
   ```

### HILS Serverに接続できない

**症状**: "Connection refused" エラー

**原因と対策**:
1. ポート8765が使用中
   ```cmd
   netstat -ano | findstr :8765
   ```
   → 使用中のプロセスを終了

2. ファイアウォールでブロック
   → ファイアウォール設定でPythonを許可

3. サーバーが起動していない
   → `python run_hils_server.py` を先に実行

4. config.pyの設定が間違っている
   ```python
   HILS_SERVER_HOST = "localhost"
   HILS_SERVER_PORT = 8765
   ```

### 実機が認識されない

**症状**: "Device not found" エラー

**原因と対策**:
1. AD3が接続されていない
   → USBケーブルを確認、LED点灯を確認

2. WaveForms SDKがインストールされていない
   → Digilent WaveFormsをインストール

3. Arduinoが認識されていない
   ```cmd
   mode COM3  # COMポートを確認
   ```
   → デバイスマネージャーでCOMポートを確認
   → `src\utils\config.py` の `ARDUINO_PORT` を修正

4. Arduino制御プログラムが書き込まれていない
   → Arduino IDEで `arduino/mux_controller/mux_controller.ino` を書き込み

### 推論精度が低い

**症状**: 平均誤差が10mm以上

**原因と対策**:
1. データ量が不足
   → 100サンプル以上収集（各位置10サンプル以上）

2. データの分布が偏っている
   → グリッド全体に均等にデータを配置

3. 周波数が最適でない
   → 周波数分析を実行して最適周波数を設定

4. ノイズが多い
   → 測定環境を改善（電磁ノイズ源から離す）
   → `config.py` の `NOISE_LEVEL` を確認

5. モデルの設定が不適切
   → `config.py` の `HIDDEN_LAYER_SIZES` を調整
   → 例: `(64, 32, 16)` など深いネットワークを試す

### GUIが表示されない

**症状**: ウィンドウが開かない

**原因と対策**:
1. customtkinterがインストールされていない
   ```cmd
   pip install customtkinter
   ```

2. Tkinterがインストールされていない（Python標準だが、一部の環境で欠落）
   → Pythonを再インストール（Tkinterを含むバージョン）

3. ディスプレイが検出されない（リモートデスクトップ等）
   → ローカル環境で実行

### メモリ不足エラー

**症状**: "MemoryError" または "Out of memory"

**原因と対策**:
1. データサンプル数が多すぎる
   → サンプル数を減らす（1位置あたり10～30サンプル）

2. モデルが大きすぎる
   → `config.py` の `HIDDEN_LAYER_SIZES` を小さくする
   → 例: `(16, 8)` など

3. 周波数分析の点数が多すぎる
   → `--num-points` を減らす（20→10）

---

## 📞 サポート情報

### ログファイルの確認

エラーが発生した場合、以下のログファイルを確認してください：

- `logs/test_log_*.txt` - 自動テストのログ
- コンソール出力 - リアルタイムエラーメッセージ

### よくある質問

**Q: データはどこに保存されますか？**
A: `data/` ディレクトリに `training_data_*.pkl` として保存されます。

**Q: モデルの精度を上げるには？**
A: 
1. データ量を増やす（100サンプル以上）
2. 周波数を最適化する
3. ノイズを減らす
4. ネットワーク構造を調整する

**Q: 実機とHILSの切り替え方法は？**
A: `src\utils\config.py` の `USE_REAL_HARDWARE` を変更します。

**Q: 複数のPCで使えますか？**
A: はい。HILS Serverを1台で起動し、他のPCからクライアントとして接続できます。
   `src\utils\config.py` の `HILS_SERVER_HOST` にサーバーのIPアドレスを設定してください。

### 詳細ドキュメント

- [README.md](README.md) - プロジェクト概要
- [STRUCTURE.md](STRUCTURE.md) - システムアーキテクチャ
- [REFACTORING.md](REFACTORING.md) - リファクタリング履歴

### コミュニティ

問題が解決しない場合は、GitHubのIssuesセクションで質問してください。

---

**最終更新**: 2026年2月8日
